{% extends "base.html" %}
{% block content %}
<h1 class="impact-title mb-4">Panel del Supervisor</h1>

<form id="upload-form" class="card p-3 mb-4" method="POST" action="{{ url_for('upload') }}" enctype="multipart/form-data">
  <div class="row g-3">
    <div class="col-md-4">
      <label class="form-label">Asesor</label>
      <select id="advisor" name="advisor" class="form-select" required></select>
      <div class="form-text">Al elegir asesor, se completa campaña.</div>
    </div>

    <div class="col-md-4">
      <label class="form-label">Campaña del asesor</label>
      <input id="campaign" class="form-control" disabled>
    </div>

    <div class="col-md-4">
      <label class="form-label">N° móvil del audio</label>
      <input name="mobile" class="form-control" value="999999999" placeholder="999999999">
      <div class="form-text">Se mostrará en la tabla como Móvil.</div>
    </div>

    <div class="col-md-6">
      <label class="form-label">Tipificación del audio</label>
      <select id="tipificacion" name="tipificacion" class="form-select" required></select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Audio</label>
      <div class="d-flex gap-2">
        <input id="audio" name="audio" type="file" accept="audio/*" class="form-control" required>
        <button type="submit" class="btn btn-primary" id="btn-upload">Subir y analizar</button>
      </div>
    </div>

    <div class="col-12 d-flex flex-wrap gap-2">
      <button type="button" class="btn btn-outline-secondary" id="btn-export">Exportar Excel</button>
      <button type="button" id="view-metrics" class="btn btn-outline-dark">Ver métricas</button>
    </div>
  </div>
</form>

<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="mb-0">Auditorías recientes</h5>
    <div class="d-flex align-items-center gap-2">
      <label class="small text-muted">Mostrar</label>
      <select id="page-size" class="form-select form-select-sm" style="width:auto">
        <option value="10" selected>10</option>
        <option value="25">25</option>
        <option value="50">50</option>
      </select>
      <span class="small text-muted">por página</span>
      <div class="btn-group">
        <button class="btn btn-sm btn-outline-secondary" id="prev-page">&laquo;</button>
        <button class="btn btn-sm btn-outline-secondary" id="next-page">&raquo;</button>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Fecha subida</th>
          <th>Asesor</th>
          <th>Campaña</th>
          <th>Móvil</th>
          <th>Tipificación</th>
          <th style="width:260px">AUDIO</th>
          <th>Feedback</th>
          <th>Confirmación</th>
        </tr>
      </thead>
      <tbody id="audits-body"></tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-2">
    <div class="small text-muted">Mostrando <span id="pag-from">0</span>–<span id="pag-to">0</span> de <span id="pag-total">0</span></div>
  </div>
</div>

<!-- Modal feedback -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Feedback</h5>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="feedbackHtml" class="coaching-rich"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal MÉTRICAS -->
<div class="modal fade" id="metricsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Métricas</h5>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="row g-4">
          <div class="col-lg-6">
            <h6 class="mb-2">1) Auditorías por día</h6>
            <canvas id="chartByDay"></canvas>
          </div>
          <div class="col-lg-6">
            <h6 class="mb-2">2) Auditoría por tipificación por día</h6>
            <canvas id="chartTipiByDay"></canvas>
          </div>
          <div class="col-lg-6">
            <h6 class="mb-2">3) Auditorías semanales</h6>
            <canvas id="chartWeekly"></canvas>
          </div>
          <div class="col-lg-6">
            <h6 class="mb-2">4) Acumulado del mes por asesor</h6>
            <canvas id="chartMonthByAdvisor"></canvas>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal REPRODUCTOR DE AUDIO -->
<div class="modal fade" id="audioModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Reproductor de audio</h6>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <audio id="modalAudio" controls controlsList="nodownload noremoteplayback" style="width:100%"></audio>

        <div class="d-flex flex-wrap gap-2 mt-3">
          <div class="btn-group" role="group" aria-label="Salto">
            <button class="btn btn-outline-secondary btn-sm" data-skip="-30">-30s</button>
            <button class="btn btn-outline-secondary btn-sm" data-skip="-10">-10s</button>
            <button class="btn btn-outline-secondary btn-sm" data-skip="10">+10s</button>
            <button class="btn btn-outline-secondary btn-sm" data-skip="30">+30s</button>
          </div>
          <div class="btn-group ms-auto" role="group" aria-label="Velocidad">
            <button class="btn btn-outline-secondary btn-sm" data-rate="0.75">0.75×</button>
            <button class="btn btn-outline-secondary btn-sm" data-rate="1">1×</button>
            <button class="btn btn-outline-secondary btn-sm" data-rate="1.25">1.25×</button>
            <button class="btn btn-outline-secondary btn-sm" data-rate="1.5">1.5×</button>
            <button class="btn btn-outline-secondary btn-sm" data-rate="2">2×</button>
          </div>
        </div>

        <div class="mt-3">
          <input type="range" id="seekRange" min="0" max="1000" step="1" class="form-range">
          <div class="d-flex justify-content-between small text-muted">
            <span id="curTime">00:00</span>
            <span id="durTime">00:00</span>
          </div>
        </div>
        <div class="small text-muted mt-1">Tip: usa <kbd>Espacio</kbd> para pausar/reanudar cuando este modal esté abierto.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<style>
  .coaching-rich h6{font-weight:700;margin:12px 0 6px}
  .coaching-rich ul{margin:0 0 10px 1.2rem}
  .coaching-rich .tag{font-weight:600}
</style>

<script>
  const API_AUDITS = "{{ url_for('api_audits') }}";
  const API_ADVISORS = "{{ url_for('api_advisors') }}";
  const API_TIPIS = "{{ url_for('api_tipificaciones') }}";

  const esc = s => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m]));

  function formatCoachingHtml(raw){
    const text = String(raw||'');
    const lines = text.split(/\r?\n/);
    let html = '', inList = false;

    const esc = s => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m]));
    const boldMD = s => s.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
    const openList = ()=>{ if(!inList){ html += '<ul>'; inList = true; } };
    const closeList = ()=>{ if(inList){ html += '</ul>'; inList = false; } };

    for (let line of lines){
      line = line.trim();
      if (!line) continue;

      // Encabezados 3), 4) y 6)
      if (/^3\)\s*Contexto y Resultado Detallado:/i.test(line)){
        closeList(); html += '<h6>3) Contexto y Resultado Detallado</h6>'; continue;
      }
      if (/^4\)\s*Análisis Táctico Detallado/i.test(line)){
        closeList(); html += '<h6>4) Análisis Táctico Detallado de la Interacción (Foco en Factibilidad y Conversión)</h6>'; continue;
      }
      if (/^6\)\s*Recomendaciones/i.test(line)){
        closeList(); html += '<h6>6) Recomendaciones Estratégicas y Ejemplos de Guion (Acción Inmediata)</h6>'; continue;
      }

      // Viñetas: •, -, o  (el A365 suele usar "o " en los subapartados del 4)
      if (/^(?:[•\-]|o)\s+/.test(line)){
        openList();
        let li = line.replace(/^(?:[•\-]|o)\s+/, '');
        li = esc(li);
        li = boldMD(li);
        li = li.replace(/\b(Punto Crítico:|Sondeo para Necesidad de Fibra:|Presentación de Valor de Fibra:|Manejo de Objeciones:|Cierre y Programación de Instalación:|Oportunidades Perdidas:|Momento y Justificación:|Manejo de la Reticencia:|Observaciones del Audio \(Tono\/Ritmo\):)/g,'<span class="tag">$1</span>');
        html += '<li>'+li+'</li>';
        continue;
      }

      // Párrafos normales (con **negritas**)
      closeList();
      html += '<p class="mb-2">'+ boldMD(esc(line)) +'</p>';
    }
    closeList();
    return html || '<p class="text-muted">Sin contenido.</p>';
  }

  // ====== Asesores + autocompletar campaña ======
  async function loadAdvisors(){
    try{
      const sel = document.getElementById('advisor');
      sel.innerHTML = '<option value="" disabled selected>Seleccione asesor...</option>';
      const r = await fetch(API_ADVISORS);
      if(!r.ok) throw new Error('advisors HTTP '+r.status);
      const list = await r.json();
      list.forEach(it=>{
        const opt = document.createElement('option');
        opt.value = it.advisor;
        opt.textContent = it.advisor;
        opt.dataset.camp = it.campaign || '';
        sel.appendChild(opt);
      });
      sel.addEventListener('change', ()=>{
        const camp = sel.options[sel.selectedIndex]?.dataset?.camp || '';
        document.getElementById('campaign').value = camp;
      });
    }catch(e){
      console.warn('loadAdvisors error', e);
      document.getElementById('advisor').innerHTML =
        '<option value="" disabled selected>Error cargando asesores</option>';
    }
  }

  // ====== Tipificaciones ======
  async function loadTipificaciones(){
    try{
      const sel = document.getElementById('tipificacion');
      const r = await fetch(API_TIPIS);
      if(!r.ok) throw new Error('tipis HTTP '+r.status);
      const list = await r.json();
      sel.innerHTML = '<option value="" disabled selected>Seleccione tipificación…</option>' +
        list.map(t=>`<option value="${esc(t.grouped)}" data-display="${esc(t.display)}">${esc(t.display)}</option>`).join('');
    }catch(e){
      console.warn('loadTipificaciones error', e);
      document.getElementById('tipificacion').innerHTML =
        '<option value="" disabled selected>Error cargando tipificaciones</option>';
    }
  }

  // ====== Tabla + Paginación ======
  let AUDITS = [], PAGE = 1, PAGE_SIZE = 10;
  function fmtDate(iso){ return String(iso||'').replace('T',' ').slice(0,19); }

  function renderAuditsPage(){
    const body = document.getElementById('audits-body');
    const total = AUDITS.length;
    const start = (PAGE-1)*PAGE_SIZE;
    const end = Math.min(start+PAGE_SIZE, total);
    document.getElementById('pag-total').textContent = total;
    document.getElementById('pag-from').textContent = total? (start+1): 0;
    document.getElementById('pag-to').textContent = end;

    if (!total){
      body.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Sin registros</td></tr>';
      return;
    }

    const rows = AUDITS.slice(start, end).map(a=>{
      const src = esc(a.audio_url||'');
      const au = a.audio_url ? `
        <audio class="inline-audio" controls controlsList="nodownload noremoteplayback" oncontextmenu="return false" style="width:220px">
          <source src="${src}">
        </audio>
        <div><button class="btn btn-sm btn-outline-primary mt-1 open-player" data-src="${src}">Abrir reproductor</button></div>
      ` : '<span class="text-muted">Sin audio</span>';

      const feedbackText = (a.detail_3_6_8 || a.feedback || '');
      const short = esc(feedbackText.replace(/\s+/g,' ').slice(0,160)) + (feedbackText.length>160 ? '…' : '');
      const btn = `<button class="btn btn-sm btn-primary" onclick="showFeedback(${Number(a.id)})">Ver más</button>`;
      const badge = a.advisor_confirmed ? '<span class="badge bg-success">Confirmado</span>' : '<span class="badge bg-warning text-dark">Pendiente</span>';

      return `<tr>
        <td>${fmtDate(a.created_at)}</td>
        <td>${esc(a.advisor)}</td>
        <td>${esc(a.campaign||'')}</td>
        <td>${esc(a.mobile_number||a.mobile||'')}</td>
        <td>${esc(a.tipificacion||'')}</td>
        <td>${au}</td>
        <td><div class="small mb-1">${short || '<span class="text-muted">Sin contenido</span>'}</div>${btn}</td>
        <td>${badge}</td>
      </tr>`;
    });
    body.innerHTML = rows.join('');

    // Abrir modal al dar play en el inline player
    document.querySelectorAll('audio.inline-audio').forEach(a=>{
      a.addEventListener('play', (ev)=>{
        try { ev.target.pause(); } catch(e){}
        const src = a.querySelector('source')?.src || a.currentSrc || '';
        if (src) openAudioModal(src);
      });
    });
    body.querySelectorAll('.open-player').forEach(b=>{
      b.addEventListener('click', ()=> openAudioModal(b.dataset.src));
    });
  }

  async function loadAudits(){
    try{
      const r = await fetch(API_AUDITS);
      if(!r.ok) throw new Error('audits HTTP '+r.status);
      AUDITS = await r.json();
      window.__AUDITS_CACHE__ = AUDITS;
      PAGE = 1; renderAuditsPage();
    }catch(e){
      console.warn('loadAudits error', e);
      AUDITS = []; window.__AUDITS_CACHE__ = [];
      renderAuditsPage();
    }
  }

  document.getElementById('page-size').addEventListener('change', (e)=>{
    PAGE_SIZE = parseInt(e.target.value, 10) || 10;
    PAGE = 1; renderAuditsPage();
  });
  document.getElementById('prev-page').addEventListener('click', ()=>{
    if (PAGE > 1){ PAGE--; renderAuditsPage(); }
  });
  document.getElementById('next-page').addEventListener('click', ()=>{
    const maxPage = Math.ceil(AUDITS.length / PAGE_SIZE) || 1;
    if (PAGE < maxPage){ PAGE++; renderAuditsPage(); }
  });

  window.showFeedback = function(id){
    const arr = (window.__AUDITS_CACHE__||[]);
    const item = arr.find(x=> String(x.id) == String(id));
    const txt = (item?.detail_3_6_8 || item?.feedback || '').trim();
    document.getElementById('feedbackHtml').innerHTML = formatCoachingHtml(txt);
    new bootstrap.Modal(document.getElementById('feedbackModal')).show();
  };

  // ========= MÉTRICAS =========
  function parseDateSafe(v){
    if(!v) return null;
    let d = new Date(v);
    if (isNaN(d.getTime())) d = new Date(String(v).replace(' ', 'T'));
    return isNaN(d.getTime()) ? null : d;
  }

  function buildWeeklyCounts(items){
    const now = new Date();
    const y = now.getFullYear(), m = now.getMonth();
    const buckets = [0,0,0,0,0]; // S1..S5
    for (const a of items){
      const d = parseDateSafe(a.created_at);
      if(!d) continue;
      if (d.getFullYear() !== y || d.getMonth() !== m) continue;
      const day = d.getDate();
      let idx = 4; // 29–31
      if (day <= 7) idx = 0;
      else if (day <= 14) idx = 1;
      else if (day <= 21) idx = 2;
      else if (day <= 28) idx = 3;
      buckets[idx] += 1;
    }
    return buckets;
  }

  async function showMetrics(){
    await window.__chartReady;
    const mm = new bootstrap.Modal(document.getElementById('metricsModal'));
    mm.show();

    // #1 Auditorías por día
    (async ()=>{
      const byDay = {};
      for(const a of AUDITS){
        const d = parseDateSafe(a.created_at); if(!d) continue;
        const k = d.toISOString().slice(0,10);
        byDay[k] = (byDay[k]||0)+1;
      }
      const labels = Object.keys(byDay).sort();
      const data = labels.map(k=>byDay[k]);
      await window.createChartSafely(
        document.getElementById('chartByDay'),
        window.normalizeConfigV4({
          type: 'bar',
          data: { labels, datasets: [{ label: 'Total', data }] },
          options: { responsive:true, plugins:{ legend:{display:true} }, scales:{ y:{ beginAtZero:true } } }
        })
      );
    })();

    // #2 Tipificación por día (mes actual)
    (async ()=>{
      const now = new Date(); const ym = now.toISOString().slice(0,7);
      const map = {};
      for(const a of AUDITS){
        const d = parseDateSafe(a.created_at); if(!d) continue;
        const dayKey = d.toISOString().slice(0,10);
        if(!dayKey.startsWith(ym)) continue;
        const tipi = a.tipificacion || 'Sin tipificación';
        map[tipi] = map[tipi] || {};
        map[tipi][dayKey] = (map[tipi][dayKey]||0)+1;
      }
      const allDays = [...new Set(Object.values(map).flatMap(obj=>Object.keys(obj)))].sort();
      const datasets = Object.keys(map).slice(0,5).map((tipi)=>({
        label: tipi, data: allDays.map(d=>map[tipi][d]||0), borderWidth:1
      }));
      await window.createChartSafely(
        document.getElementById('chartTipiByDay'),
        window.normalizeConfigV4({
          type:'bar',
          data:{ labels: allDays, datasets },
          options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
        })
      );
    })();

    // #3 Auditorías semanales
    (async ()=>{
      const counts = buildWeeklyCounts(AUDITS);
      const labels = [
        'Semana 1 (1–7)',
        'Semana 2 (8–14)',
        'Semana 3 (15–21)',
        'Semana 4 (22–28)',
        'Semana 5 (29–31)'
      ];
      await window.createChartSafely(
        document.getElementById('chartWeekly'),
        window.normalizeConfigV4({
          type:'bar',
          data:{ labels, datasets:[{ label:'Total', data: counts }] },
          options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
        })
      );
    })();

    // #4 Acumulado del mes por asesor
    (async ()=>{
      const now = new Date(); const ym = now.toISOString().slice(0,7);
      const byAdvisor = {};
      for(const a of AUDITS){
        const d = parseDateSafe(a.created_at); if(!d) continue;
        if(!d.toISOString().startsWith(ym)) continue;
        const adv = a.advisor || 'Sin asesor';
        byAdvisor[adv] = (byAdvisor[adv]||0)+1;
      }
      const labels = Object.keys(byAdvisor).sort((a,b)=>byAdvisor[b]-byAdvisor[a]).slice(0,10);
      const data = labels.map(n=>byAdvisor[n]);
      await window.createChartSafely(
        document.getElementById('chartMonthByAdvisor'),
        window.normalizeConfigV4({
          type:'bar',
          data:{ labels, datasets:[{ label:'Mes actual', data }] },
          options:{ indexAxis:'y', responsive:true, scales:{ x:{ beginAtZero:true } } }
        })
      );
    })();
  }
  document.getElementById('view-metrics').addEventListener('click', showMetrics);

  // ====== SUBIDA SIN RECARGAR ======
  document.getElementById('upload-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const form = e.currentTarget;
    const btn = document.getElementById('btn-upload');
    const defaultHtml = btn.innerHTML;
    btn.disabled = true; btn.innerHTML = 'Subiendo…';
    try{
      const fd = new FormData(form);
      const res = await fetch(form.action, { method:'POST', body: fd });
      if (!res.ok) throw new Error('Error HTTP '+res.status);
      await loadAudits();
      document.getElementById('audio').value = '';
      form.querySelector('input[name="mobile"]').value = '999999999';
    }catch(err){
      console.warn(err);
      alert('Hubo un problema subiendo el audio.');
    }finally{
      btn.disabled = false; btn.innerHTML = defaultHtml;
    }
  });

  // ====== EXPORTAR (sin pedir usuario) ======
  document.getElementById('btn-export').addEventListener('click', ()=>{
    window.location.href = "{{ url_for('export_supervisor') }}";
  });

  // ====== MODAL DE AUDIO ======
  const audioModal = document.getElementById('audioModal');
  const modalAudio = document.getElementById('modalAudio');
  const seekRange = document.getElementById('seekRange');
  const curTime = document.getElementById('curTime');
  const durTime = document.getElementById('durTime');
  let seekTimer = null;

  function fmt(t){
    if (!isFinite(t)) return '00:00';
    const m = Math.floor(t/60);
    const s = Math.floor(t%60);
    return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
  }

  function updateSeekUI(){
    const dur = modalAudio.duration || 0;
    const cur = modalAudio.currentTime || 0;
    seekRange.value = dur ? Math.round((cur/dur)*1000) : 0;
    curTime.textContent = fmt(cur);
    durTime.textContent = fmt(dur);
  }

  function openAudioModal(src){
    modalAudio.pause();
    modalAudio.src = src || '';
    modalAudio.currentTime = 0;
    updateSeekUI();
    new bootstrap.Modal(audioModal).show();
    // reproducción sólo si el usuario presiona play en el modal
  }

  audioModal.addEventListener('shown.bs.modal', ()=>{
    if (seekTimer) clearInterval(seekTimer);
    seekTimer = setInterval(updateSeekUI, 200);
  });
  audioModal.addEventListener('hidden.bs.modal', ()=>{
    modalAudio.pause();
    if (seekTimer) { clearInterval(seekTimer); seekTimer = null; }
  });

  modalAudio.addEventListener('timeupdate', updateSeekUI);
  seekRange.addEventListener('input', ()=>{
    const dur = modalAudio.duration || 0;
    modalAudio.currentTime = (seekRange.value/1000)*dur;
  });

  // botones de salto y velocidad
  audioModal.querySelectorAll('[data-skip]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const delta = Number(btn.getAttribute('data-skip')||0);
      modalAudio.currentTime = Math.max(0, Math.min((modalAudio.currentTime||0)+delta, modalAudio.duration||0));
    });
  });
  audioModal.querySelectorAll('[data-rate]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ modalAudio.playbackRate = Number(btn.getAttribute('data-rate')||1); });
  });

  // ====== INIT ======
  document.addEventListener('DOMContentLoaded', async ()=>{
    await Promise.all([loadAdvisors(), loadTipificaciones()]);
    await loadAudits();

    if (location.hash === '#metrics') {
      showMetrics();
    }
  });
</script>
{% endblock %}
