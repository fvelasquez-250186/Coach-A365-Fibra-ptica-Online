<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Auditorías - Impulsa365</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

  <style>
    body{font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;}
    .impact-title{font-weight:800;letter-spacing:0.5px;}
    audio::-webkit-media-controls-download-button{display:none!important;}
    audio{width:100%;}
    .brand-logo{height:32px;max-height:32px;width:auto;display:block;image-rendering:-webkit-optimize-contrast;}
    .navbar .nav-link{font-weight:600;}
  </style>

  <!-- Chart.js v4 + fallbacks robustos -->
  <script>
    async function loadScriptWithFallback(urls) {
      for (const url of urls) {
        try {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = url; s.async = true; s.onload = resolve; s.onerror = reject;
            document.head.appendChild(s);
          });
          return true;
        } catch (e) {}
      }
      return false;
    }

    window.__chartReady = (async () => {
      const ok = await loadScriptWithFallback([
        "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js",
        "https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js",
        "/static/vendor/chart.js@4.4.1/chart.umd.min.js"
      ]);
      if (!ok || !window.Chart) {
        console.error("No se pudo cargar Chart.js.");
        window.Chart = function(){ return { destroy(){}, update(){}, }; };
      }
      return window.Chart;
    })();
  </script>
</head>
<body>
  <!-- Navbar unificada -->
  <nav class="navbar navbar-dark bg-dark shadow-sm">
    <div class="container-fluid justify-content-between align-items-center">
      <!-- Izquierda: Entel -->
      <a class="navbar-brand d-flex align-items-center gap-2" href="{{ url_for('supervisor_dashboard') }}">
        <img src="{{ entel_logo or url_for('static', filename='brand/entel.svg') }}" class="brand-logo" alt="Entel">
      </a>

      <!-- Centro: auth -->
      <div class="d-flex align-items-center gap-3">
        {% if session.get('dni') %}
          <span class="text-white-50 small">Supervisor: {{ session.get('sup_name') }}</span>
          <a class="btn btn-sm btn-outline-light" href="{{ url_for('logout') }}">Salir</a>
        {% else %}
          <a class="btn btn-sm btn-outline-light" href="{{ url_for('login') }}">Acceder</a>
        {% endif %}
      </div>

      <!-- Derecha: Impulsa -->
      <div class="d-flex align-items-center">
        <img src="{{ impulsa_logo or url_for('static', filename='brand/impulsa.svg') }}" class="brand-logo" alt="Impulsa365">
      </div>
    </div>
  </nav>

  <main class="container my-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for category, msg in messages %}
            <div class="alert alert-{{category}}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <script>
    window.createChartSafely = async function(canvas, config) {
      await window.__chartReady;
      if (!canvas) return null;
      if (canvas.__chartInstance) {
        try { canvas.__chartInstance.destroy(); } catch(e){}
      }
      try {
        const ctx = canvas.getContext('2d');
        const chart = new Chart(ctx, config);
        canvas.__chartInstance = chart;
        return chart;
      } catch (e) {
        console.error("Error creando gráfico:", e);
        return null;
      }
    };

    window.normalizeConfigV4 = function(cfg){
      if (cfg && cfg.options && cfg.options.scales) {
        const s = cfg.options.scales;
        if (s.yAxes || s.xAxes) {
          const y = (s.yAxes && s.yAxes[0]) || {};
          const x = (s.xAxes && s.xAxes[0]) || {};
          cfg.options.scales = {
            y: { beginAtZero: true, ...y },
            x: { ...x }
          };
          delete cfg.options.scales.yAxes;
          delete cfg.options.scales.xAxes;
        }
      }
      return cfg;
    };
  </script>
</body>
</html>
